import * as React from 'react';


// A custom hook for a value to be updated and stored in local storage.
// The "key" is a unique identifier for the value in question in the storage.
// This allows this hook to be used for more than one purpose hereafter.
// I.e. for the searchTerm and also possibly for other variables.
const useStorageState = (key, initialState) => {

  // The React useState hook is used for managing the state of a searched term.
  // The initial state of "value" (searched term) is either retrieved from local
  // storage if it exists there or is set to the given initialState.
  const [value, setValue] = React.useState(
    localStorage.getItem(key) || initialState
  );

  // The React useEffect hook us used to trigger a side-effect whenever "value"
  // (searched term) changes. Basically, when the search term changes (a char is
  // entered or deleted, the most recent "value" is stored in the browser so as
  // to be remembered if the user closes the browser page.
  // useEffect takes two args. The first is the actual side-effect that is run.
  // The second is an array of variables. If any of the variables change, the
  // side-effect is run.
  React.useEffect(() => {
      localStorage.setItem(key, value);
    }, [value, key]
  );

  return [value, setValue];
};


// Developer stories.
const initialStories = [
  {
    objectID: 0,
    title: "React",
    url: "https://reactjs.org/",
    author: "Jordan Walke",
    num_comments: 3,
    points: 4,
  },
  {
    objectID: 1,
    title: "Redux",
    url: "https://redux.js.org/",
    author: "Dan Abramov, Andrew Clark",
    num_comments: 2,
    points: 5,
  },
  {
    objectID: 2,
    title: "Alpine JS",
    url: "https://redux.js.org/",
    author: "Raymond Wigshaw",
    num_comments: 4,
    points: 3,
  },
  {
    objectID: 3,
    title: "Bootstrap",
    url: "https://redux.js.org/",
    author: "Susan Flywheel",
    num_comments: 4,
    points: 3,
  },
  {
    objectID: 4,
    title: "Django",
    url: "https://redux.js.org/",
    author: "Jennifer Workgray",
    num_comments: 4,
    points: 3,
  },
  {
    objectID: 5,
    title: "Django Rest Framework",
    url: "https://redux.js.org/",
    author: "Jimbo Greenchin",
    num_comments: 4,
    points: 3,
  },
]


// A promise for an object holding a list of stories.
// Set up so as to simulate calling an external API (e.g. with a delay of 1 sec)
// to receive a list of stories.
const getAsyncStories = () =>
  new Promise((resolve) =>
    setTimeout(() =>
      resolve({ data: { stories: initialStories } }),
      1000
    )
  );


// The main app component.
const App = () => {

  // State hook used for a loading indicator when data is being fetched.
  const [isLoading, setIsLoading] = React.useState(false);

  // State hook used for error handling when data is fetched.
  const [isError, setIsError] = React.useState(false);

  // CRUD functionality.

  // The React hook "useState" is used to make the list of stories stateful.
  const [stories, setStories] = React.useState([]);

  // An empty array of stories is initially used when rendering the components,
  // and then the stories are fetched asynchronously using the side-effect hook
  // shown below.
  // The loading indicator is set to true/false accordingly therein.
  React.useEffect(() => {
    setIsLoading(true);
    getAsyncStories()
      .then(result => {
        setStories(result.data.stories);
        setIsLoading(false);
      })
      .catch(() => setIsError(true));
  }, []);

  // An event handler to remove an item from the list.
  // Creates a new array containing all the items that do not have the same
  // object ID as the item to be removed.
  const handleRemoveStory = (item) => {
    const newStories = stories.filter(
      (story) => story.objectID !== item.objectID
    );
    setStories(newStories);
  };

  // Search functionality.

  // Uses the custom hook declared above.
  // "search" is passed as a key underwhich searchTerm is stored in local storage.
  // "" is the initial state os searchTerm.
  const [searchTerm, setSearchTerm] = useStorageState("search", "");

  // An event handler that is used as a callback handler for information to be
  // passed from a child to a parent component (here, the information is an event
  // generated by keyboard input in the input field in the Search component).
  const handleSearch = (event) => {
    // Update state of searchTerm.
    setSearchTerm(event.target.value);
  };

  // Filters the available stories by the current searchTerm defined in the
  // above state handler.
  const searchedStories = stories.filter((story) =>
    story.title.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <>
      <h1>My Hacker Stories</h1>

      {/* Above handleSearch event handler passed to the Search component.
          The current searchTerm is also passed down.
          Just using "isFocused" is the same as "isFocused={true}" */}
      <InputWithLabel
        id="search"
        type="text"
        value={searchTerm}
        onInputChange={handleSearch}
        isFocused
      >
          <strong>Search:</strong>
      </InputWithLabel>

      <br />
      <hr />

      {/* Conditional rendering based on "isError".
          If true, an error message is displayed.
          If false, nothing is displayed. */}
      {isError ? (
        <p>Something went wrong...</p>
      ) : (
        null
      )}

      {/* Conditional rendering based on "isLoading".
          If true, a loading indicator is displayed.
          If false, the list of stories is displayed. */}
      {isLoading ? (
        <p>Loading...</p>
      ) : (
        <List list={searchedStories} onRemoveItem={handleRemoveStory} />
      )}

    </>
  );
};


// Component for displaying an input field with a label.
// Designed to be reusable for different kinds of input fields, but in the case
// of this app, this is just used for the search field which accepts text.
// The "children" prop passes everthing included between the <InputWithLabel>
// opening and closing tags when instantiated in App, which in this case is:
// "<strong>Search:</strong>"
const InputWithLabel = ({id, type, value, onInputChange, isFocused, children}) => {
  return (
    <>
      {/* "htmlFor" is the JSX version of the "for" attribute used in an
          ordinary HTML label tag. */}
      <label htmlFor={id}>{children}</label>

      &nbsp;

      {/* By passing the current searched term from App to here as the "value",
          this can be explicitly set as the value of the below input field.

          If an onChange event occurs in the input field (basically if a single
          char is entered/deleted), this is passed to onInputChange which is
          defined in the InputWithLabel instantiation in App, and is then
          handled by handleSearch.
          This process of passing state from a child component to the parent
          component is called "lifting state". */}
      <input
        id={id}
        type={type}
        value={value}
        onChange={onInputChange}
        autoFocus={isFocused}
      />
    </>
  );
};


// Component for displaying a list of stories.
// Instead of passing "props" to this component and then using "props.list" in
// the component, it is more conventional to use JS object destructuring in the
// component's function signature "{ list, onRemoveItem }" to make it possible
// to then simply use "list" instead of "props.list", "props.onRemoveItem", etc.
// "onRemoveItem" is an event handler being passed down from App to Item.
const List = ({ list, onRemoveItem }) => {
  return (
    <ul>
      {list.map((item) => {
        return (
          <Item
            key={item.objectID}
            item={item}
            onRemoveItem={onRemoveItem}
          />
        );
      })}
    </ul>
  );
};


// Component for displaying an individual item of a list.
const Item = ({ item, onRemoveItem }) => {

  // Callback handler to handle removing an item.
  const handleRemoveItem = () => {
    onRemoveItem(item);
  };

  return (
    <li>
      <span>
        <a href={item.url}>{item.title}</a>
      </span>
      <span>; {item.author}</span>
      <span>; {item.num_comments} comments</span>
      <span>; {item.points} points </span>
      <span>
        <button type="button" onClick={handleRemoveItem}>
          Delete
        </button>
      </span>
    </li>
  );
};


export default App;
